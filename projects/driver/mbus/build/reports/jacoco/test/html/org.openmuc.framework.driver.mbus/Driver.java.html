<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Driver.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">openmuc-driver-mbus</a> &gt; <a href="index.source.html" class="el_package">org.openmuc.framework.driver.mbus</a> &gt; <span class="el_source">Driver.java</span></div><h1>Driver.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2011-2024 Fraunhofer ISE
 *
 * This file is part of OpenMUC.
 * For more information visit http://www.openmuc.org
 *
 * OpenMUC is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * OpenMUC is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with OpenMUC. If not, see &lt;http://www.gnu.org/licenses/&gt;.
 *
 */
package org.openmuc.framework.driver.mbus;

import java.io.IOException;
import java.io.InterruptedIOException;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

import org.openmuc.framework.config.ArgumentSyntaxException;
import org.openmuc.framework.config.DeviceScanInfo;
import org.openmuc.framework.config.DriverInfo;
import org.openmuc.framework.config.ScanException;
import org.openmuc.framework.config.ScanInterruptedException;
import org.openmuc.framework.driver.spi.Connection;
import org.openmuc.framework.driver.spi.ConnectionException;
import org.openmuc.framework.driver.spi.DriverDeviceScanListener;
import org.openmuc.framework.driver.spi.DriverService;
import org.openmuc.jmbus.MBusConnection;
import org.openmuc.jmbus.SecondaryAddress;
import org.openmuc.jmbus.SecondaryAddressListener;
import org.openmuc.jmbus.VariableDataStructure;
import org.openmuc.jmbus.VerboseMessageListener;
import org.openmuc.jrxtx.SerialPortTimeoutException;
import org.osgi.service.component.annotations.Component;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@Component
<span class="nc" id="L48">public class Driver implements DriverService {</span>

<span class="nc" id="L50">    private static final Logger logger = LoggerFactory.getLogger(Driver.class);</span>

<span class="nc" id="L52">    private final Map&lt;String, ConnectionInterface&gt; interfaces = new ConcurrentHashMap&lt;&gt;();</span>

    private static final String ID = &quot;mbus&quot;;
    private static final String DESCRIPTION = &quot;M-Bus (wired) is a protocol to read out meters.&quot;;
    private static final String DEVICE_ADDRESS = &quot;Synopsis: &lt;serial_port&gt;:&lt;mbus_address&gt; or tcp:&lt;host_address&gt;:&lt;port&gt;&quot;
            + &quot;Example for &lt;serial_port&gt;: /dev/ttyS0 (Unix), COM1 (Windows) The mbus_address can either be the primary&quot;
            + &quot; address or the secondary address&quot;;
    private static final String SETTINGS = &quot;Synopsis: [&lt;baud_rate&gt;][:t&lt;timeout&gt;][:lr][:ar][:d&lt;delay&gt;][:tc&lt;tcp_connection_timeout&gt;][sc]&quot;
            + &quot;The default baud rate is 2400. Default read timeout is 2500 ms. Delay is for slow devices who needs more time between every message, default is 0 ms.&quot;
            + &quot;Example: 9600:t5000. 'ar' means application reset and 'lr' link reset before readout. activate sc if strict device connection is needed.&quot;;
    private static final String CHANNEL_ADDRESS = &quot;Synopsis: [X]&lt;dib&gt;:&lt;vib&gt; The DIB and VIB fields in hexadecimal form separated by a colon. &quot;
            + &quot;If the channel address starts with an X then the specific data record will be selected for readout before reading it.&quot;;
    private static final String DEVICE_SCAN_SETTINGS = &quot;Synopsis: &lt;serial_port&gt;[:&lt;baud_rate&gt;][:s][:t&lt;scan_timeout&gt;]&quot;
            + &quot;Examples for &lt;serial_port&gt;: /dev/ttyS0 (Unix), COM1 (Windows); 's' for secondary address scan.&gt;&quot;;

<span class="nc" id="L67">    private static final DriverInfo info = new DriverInfo(ID, DESCRIPTION, DEVICE_ADDRESS, SETTINGS, CHANNEL_ADDRESS,</span>
            DEVICE_SCAN_SETTINGS);

    private static final String SECONDARY_ADDRESS_SCAN = &quot;s&quot;;
    private static final String APPLICATION_RESET = &quot;ar&quot;;
    private static final String LINK_RESET = &quot;lr&quot;;
    private static final String STRICT_CONNECTION = &quot;sc&quot;;
    private static final String SEPARATOR = &quot;:&quot;;

    private static final String TCP = &quot;tcp&quot;;

<span class="nc" id="L78">    private boolean strictConnectionTest = false;</span>
    boolean interruptScan;

    @Override
    public DriverInfo getInfo() {
<span class="nc" id="L83">        return info;</span>
    }

    @Override
    public void scanForDevices(String settingsString, DriverDeviceScanListener listener)
            throws ArgumentSyntaxException, ScanException, ScanInterruptedException {

<span class="nc" id="L90">        interruptScan = false;</span>

<span class="nc" id="L92">        Settings settings = new Settings(settingsString, true);</span>

        MBusConnection mBusConnection;
<span class="nc bnc" id="L95" title="All 2 branches missed.">        if (!interfaces.containsKey(settings.scanConnectionAddress)) {</span>
            try {
<span class="nc bnc" id="L97" title="All 2 branches missed.">                if (settings.host.isEmpty()) {</span>
<span class="nc" id="L98">                    mBusConnection = MBusConnection.newSerialBuilder(settings.scanConnectionAddress)</span>
<span class="nc" id="L99">                            .setBaudrate(settings.baudRate)</span>
<span class="nc" id="L100">                            .setTimeout(settings.timeout)</span>
<span class="nc" id="L101">                            .build();</span>
                }
                else {
<span class="nc" id="L104">                    mBusConnection = MBusConnection.newTcpBuilder(settings.host, settings.port)</span>
<span class="nc" id="L105">                            .setTimeout(settings.timeout)</span>
<span class="nc" id="L106">                            .setConnectionTimeout(settings.connectionTimeout)</span>
<span class="nc" id="L107">                            .build();</span>
                }
<span class="nc" id="L109">            } catch (IOException e) {</span>
<span class="nc" id="L110">                throw new ScanException(e);</span>
<span class="nc" id="L111">            }</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">            if (logger.isTraceEnabled()) {</span>
<span class="nc" id="L113">                mBusConnection.setVerboseMessageListener(new VerboseMessageListenerImpl());</span>
            }
        }
        else {
<span class="nc" id="L117">            mBusConnection = interfaces.get(settings.scanConnectionAddress).getMBusConnection();</span>
        }

<span class="nc" id="L120">        ConnectionInterface connectionInterface = interfaces.get(settings.scanConnectionAddress);</span>
<span class="nc bnc" id="L121" title="All 4 branches missed.">        if (connectionInterface != null &amp;&amp; connectionInterface.isOpen()) {</span>
<span class="nc" id="L122">            throw new ScanException(&quot;Device is already connected. Disable device which uses port &quot;</span>
<span class="nc" id="L123">                    + settings.scanConnectionAddress + &quot;, before scan.&quot;);</span>
        }

        try {
<span class="nc bnc" id="L127" title="All 2 branches missed.">            if (settings.scanSecondary) {</span>
<span class="nc" id="L128">                SecondaryAddressListenerImplementation secondaryAddressListenerImplementation = new SecondaryAddressListenerImplementation(</span>
<span class="nc" id="L129">                        listener, settings.scanConnectionAddress);</span>
<span class="nc" id="L130">                mBusConnection.scan(&quot;ffffffff&quot;, secondaryAddressListenerImplementation, settings.delay);</span>
<span class="nc" id="L131">            }</span>
            else {
<span class="nc" id="L133">                scanPrimaryAddress(listener, settings, mBusConnection);</span>
            }

<span class="nc" id="L136">        } catch (IOException e) {</span>
<span class="nc" id="L137">            logger.error(&quot;Failed to scan for devices.&quot;, e);</span>
        } finally {
<span class="nc" id="L139">            mBusConnection.close();</span>
        }

<span class="nc" id="L142">    }</span>

    private void scanPrimaryAddress(DriverDeviceScanListener listener, Settings settings, MBusConnection mBusConnection)
            throws ScanInterruptedException, ScanException {
        VariableDataStructure dataStructure;
<span class="nc bnc" id="L147" title="All 2 branches missed.">        for (int i = 0; i &lt;= 250; i++) {</span>

<span class="nc bnc" id="L149" title="All 2 branches missed.">            if (interruptScan) {</span>
<span class="nc" id="L150">                throw new ScanInterruptedException();</span>
            }

<span class="nc bnc" id="L153" title="All 2 branches missed.">            if (i % 5 == 0) {</span>
<span class="nc" id="L154">                listener.scanProgressUpdate(i * 100 / 250);</span>
            }
<span class="nc" id="L156">            logger.debug(&quot;scanning for meter with primary address {}&quot;, i);</span>
            try {
<span class="nc" id="L158">                dataStructure = mBusConnection.read(i);</span>
<span class="nc" id="L159">                sleep(settings.delay);</span>
<span class="nc" id="L160">            } catch (InterruptedIOException e) {</span>
<span class="nc" id="L161">                logger.debug(&quot;No meter found on address {}&quot;, i);</span>
<span class="nc" id="L162">                continue;</span>
<span class="nc" id="L163">            } catch (IOException e) {</span>
<span class="nc" id="L164">                throw new ScanException(e);</span>
<span class="nc" id="L165">            } catch (ConnectionException e) {</span>
<span class="nc" id="L166">                throw new ScanException(e);</span>
<span class="nc" id="L167">            }</span>

<span class="nc" id="L169">            String description = &quot;&quot;;</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">            if (dataStructure != null) {</span>
<span class="nc" id="L171">                SecondaryAddress secondaryAddress = dataStructure.getSecondaryAddress();</span>
<span class="nc" id="L172">                description = getScanDescription(secondaryAddress);</span>
            }
<span class="nc" id="L174">            listener.deviceFound(new DeviceScanInfo(settings.scanConnectionAddress + ':' + i, &quot;&quot;, description));</span>
<span class="nc" id="L175">            logger.debug(&quot;Meter found on address {}&quot;, i);</span>
        }
<span class="nc" id="L177">    }</span>

    @Override
    public void interruptDeviceScan() {
<span class="nc" id="L181">        interruptScan = true;</span>
<span class="nc" id="L182">    }</span>

    @Override
    public Connection connect(String deviceAddress, String settingsString)
            throws ArgumentSyntaxException, ConnectionException {

<span class="nc" id="L188">        String[] deviceAddressTokens = deviceAddress.trim().split(&quot;:&quot;);</span>
<span class="nc" id="L189">        String serialPortName = &quot;&quot;;</span>

<span class="nc" id="L191">        boolean isTCP = false;</span>
<span class="nc" id="L192">        String host = &quot;&quot;;</span>
<span class="nc" id="L193">        int port = 0;</span>
        int offset;

<span class="nc bnc" id="L196" title="All 2 branches missed.">        if (deviceAddressTokens[0].equalsIgnoreCase(TCP)) {</span>
<span class="nc" id="L197">            host = deviceAddressTokens[1];</span>
            try {
<span class="nc" id="L199">                port = Integer.parseInt(deviceAddressTokens[2]);</span>
<span class="nc" id="L200">            } catch (NumberFormatException e) {</span>
<span class="nc" id="L201">                throw new ArgumentSyntaxException(&quot;Could not parse port.&quot;);</span>
<span class="nc" id="L202">            }</span>
<span class="nc" id="L203">            isTCP = true;</span>
<span class="nc" id="L204">            offset = 2;</span>
        }
        else {
<span class="nc bnc" id="L207" title="All 2 branches missed.">            if (deviceAddressTokens.length != 2) {</span>
<span class="nc" id="L208">                throw new ArgumentSyntaxException(&quot;The device address does not consist of two parameters.&quot;);</span>
            }
<span class="nc" id="L210">            offset = 0;</span>
<span class="nc" id="L211">            serialPortName = deviceAddressTokens[offset];</span>
        }

        Integer mBusAddress;
<span class="nc" id="L215">        SecondaryAddress secondaryAddress = null;</span>
        try {
<span class="nc bnc" id="L217" title="All 2 branches missed.">            if (deviceAddressTokens[1 + offset].length() == 16) {</span>
<span class="nc" id="L218">                mBusAddress = 0xfd;</span>
<span class="nc" id="L219">                byte[] saData = Helper.hexToBytes(deviceAddressTokens[1 + offset]);</span>
<span class="nc" id="L220">                secondaryAddress = SecondaryAddress.newFromLongHeader(saData, 0);</span>
<span class="nc" id="L221">            }</span>
            else {
<span class="nc" id="L223">                mBusAddress = Integer.decode(deviceAddressTokens[1 + offset]);</span>
            }
<span class="nc" id="L225">        } catch (Exception e) {</span>
<span class="nc" id="L226">            throw new ArgumentSyntaxException(&quot;Settings: mBusAddress (&quot; + deviceAddressTokens[1 + offset]</span>
                    + &quot;) is not a number between 0 and 255 nor a 16 sign long hexadecimal secondary address&quot;);
<span class="nc" id="L228">        }</span>

        ConnectionInterface connectionInterface;
<span class="nc" id="L231">        Settings settings = new Settings(settingsString, false);</span>

<span class="nc" id="L233">        synchronized (this) {</span>

<span class="nc" id="L235">            synchronized (interfaces) {</span>
<span class="nc" id="L236">                connectionInterface = setConnectionInterface(deviceAddressTokens, serialPortName, isTCP, host, port,</span>
                        offset, settings);
<span class="nc" id="L238">            }</span>

<span class="nc" id="L240">            synchronized (connectionInterface) {</span>

<span class="nc bnc" id="L242" title="All 2 branches missed.">                if (strictConnectionTest) {</span>
                    try {
<span class="nc" id="L244">                        testConnection(mBusAddress, secondaryAddress, connectionInterface, settings);</span>
<span class="nc" id="L245">                    } catch (IOException e) {</span>
<span class="nc" id="L246">                        connectionInterface.close();</span>
<span class="nc" id="L247">                        throw new ConnectionException(e);</span>
<span class="nc" id="L248">                    }</span>
                }
<span class="nc" id="L250">                connectionInterface.increaseConnectionCounter();</span>
<span class="nc" id="L251">            }</span>
<span class="nc" id="L252">        }</span>

<span class="nc" id="L254">        DriverConnection driverCon = new DriverConnection(connectionInterface, mBusAddress, secondaryAddress,</span>
<span class="nc" id="L255">                settings.delay);</span>
<span class="nc" id="L256">        driverCon.setResetLink(settings.resetLink);</span>
<span class="nc" id="L257">        driverCon.setResetApplication(settings.resetApplication);</span>

<span class="nc" id="L259">        return driverCon;</span>
    }

    private void testConnection(Integer mBusAddress, SecondaryAddress secondaryAddress,
            ConnectionInterface connectionInterface, Settings settings) throws IOException, ConnectionException {
<span class="nc" id="L264">        MBusConnection mBusConnection = connectionInterface.getMBusConnection();</span>
<span class="nc" id="L265">        int delay = 100 + settings.delay;</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">        boolean usesSecondaryAddress = secondaryAddress != null;</span>

<span class="nc bnc" id="L268" title="All 4 branches missed.">        if (usesSecondaryAddress || settings.resetLink) {</span>
<span class="nc" id="L269">            linkReset(mBusAddress, secondaryAddress, connectionInterface, mBusConnection, delay);</span>
        }

<span class="nc bnc" id="L272" title="All 2 branches missed.">        if (usesSecondaryAddress) {</span>
<span class="nc" id="L273">            resetReadout(mBusAddress, settings.resetApplication, mBusConnection, delay);</span>
<span class="nc" id="L274">            mBusConnection.selectComponent(secondaryAddress);</span>
<span class="nc" id="L275">            sleep(delay);</span>
<span class="nc" id="L276">            mBusConnection.resetReadout(mBusAddress);</span>
<span class="nc" id="L277">            sleep(delay);</span>
        }
<span class="nc" id="L279">        mBusConnection.linkReset(mBusAddress);</span>
<span class="nc" id="L280">        sleep(delay);</span>
<span class="nc" id="L281">    }</span>

    private ConnectionInterface setConnectionInterface(String[] deviceAddressTokens, String serialPortName,
            boolean isTCP, String host, int port, int offset, Settings settings) throws ConnectionException {
        ConnectionInterface connectionInterface;
<span class="nc bnc" id="L286" title="All 2 branches missed.">        if (isTCP) {</span>
<span class="nc" id="L287">            connectionInterface = interfaces.get(host + port);</span>
        }
        else {
<span class="nc" id="L290">            connectionInterface = interfaces.get(serialPortName);</span>
        }

<span class="nc bnc" id="L293" title="All 2 branches missed.">        if (connectionInterface == null) {</span>
<span class="nc" id="L294">            MBusConnection mBusConnection = getMBusConnection(deviceAddressTokens, serialPortName, isTCP, host, port,</span>
                    offset, settings);

<span class="nc bnc" id="L297" title="All 2 branches missed.">            if (logger.isTraceEnabled()) {</span>
<span class="nc" id="L298">                mBusConnection.setVerboseMessageListener(new VerboseMessageListenerImpl());</span>
            }

<span class="nc bnc" id="L301" title="All 2 branches missed.">            if (isTCP) {</span>
<span class="nc" id="L302">                connectionInterface = new ConnectionInterface(mBusConnection, host, port, settings.delay, interfaces);</span>
            }
            else {
<span class="nc" id="L305">                connectionInterface = new ConnectionInterface(mBusConnection, serialPortName, settings.delay,</span>
                        interfaces);
            }
        }
<span class="nc" id="L309">        return connectionInterface;</span>
    }

    private MBusConnection getMBusConnection(String[] deviceAddressTokens, String serialPortName, boolean isTCP,
            String host, int port, int offset, Settings settings) throws ConnectionException {
        MBusConnection connection;
        try {
<span class="nc bnc" id="L316" title="All 2 branches missed.">            if (isTCP) {</span>
<span class="nc" id="L317">                connection = MBusConnection.newTcpBuilder(host, port)</span>
<span class="nc" id="L318">                        .setConnectionTimeout(settings.connectionTimeout)</span>
<span class="nc" id="L319">                        .setTimeout(settings.timeout)</span>
<span class="nc" id="L320">                        .build();</span>
            }
            else {
<span class="nc" id="L323">                connection = MBusConnection.newSerialBuilder(serialPortName)</span>
<span class="nc" id="L324">                        .setBaudrate(settings.baudRate)</span>
<span class="nc" id="L325">                        .setTimeout(settings.timeout)</span>
<span class="nc" id="L326">                        .build();</span>

            }
<span class="nc" id="L329">        } catch (IOException e) {</span>
<span class="nc" id="L330">            throw new ConnectionException(&quot;Unable to bind local interface: &quot; + deviceAddressTokens[offset], e);</span>
<span class="nc" id="L331">        }</span>
<span class="nc" id="L332">        return connection;</span>
    }

    private void resetReadout(Integer mBusAddress, boolean resetApplication, MBusConnection mBusConnection, int delay)
            throws IOException, ConnectionException {
<span class="nc bnc" id="L337" title="All 2 branches missed.">        if (resetApplication) {</span>
<span class="nc" id="L338">            mBusConnection.resetReadout(mBusAddress);</span>
<span class="nc" id="L339">            sleep(delay);</span>
        }
<span class="nc" id="L341">    }</span>

    private void linkReset(Integer mBusAddress, SecondaryAddress secondaryAddress,
            ConnectionInterface connectionInterface, MBusConnection mBusConnection, int delay)
            throws IOException, ConnectionException {
        try {
<span class="nc" id="L347">            mBusConnection.linkReset(mBusAddress);</span>
<span class="nc" id="L348">            sleep(delay); // for slow slaves</span>
<span class="nc" id="L349">        } catch (SerialPortTimeoutException e) {</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">            if (secondaryAddress == null) {</span>
<span class="nc" id="L351">                serialPortTimeoutExceptionHandler(connectionInterface, e);</span>
            }
<span class="nc" id="L353">        }</span>
<span class="nc" id="L354">    }</span>

    private void serialPortTimeoutExceptionHandler(ConnectionInterface connectionInterface,
            SerialPortTimeoutException e) throws ConnectionException {
<span class="nc bnc" id="L358" title="All 2 branches missed.">        if (connectionInterface.getDeviceCounter() == 0) {</span>
<span class="nc" id="L359">            connectionInterface.close();</span>
        }
<span class="nc" id="L361">        throw new ConnectionException(e);</span>
    }

    private void sleep(long millisec) throws ConnectionException {
<span class="nc bnc" id="L365" title="All 2 branches missed.">        if (millisec &gt; 0) {</span>
            try {
<span class="nc" id="L367">                Thread.sleep(millisec);</span>
<span class="nc" id="L368">            } catch (InterruptedException e) {</span>
<span class="nc" id="L369">                throw new ConnectionException(e);</span>
<span class="nc" id="L370">            }</span>
        }
<span class="nc" id="L372">    }</span>

    class SecondaryAddressListenerImplementation implements SecondaryAddressListener {
        private final DriverDeviceScanListener driverDeviceScanListener;
        private final String connectionAddress;

        private SecondaryAddressListenerImplementation(DriverDeviceScanListener driverDeviceScanListener,
<span class="nc" id="L379">                String connectionAddress) {</span>
<span class="nc" id="L380">            this.driverDeviceScanListener = driverDeviceScanListener;</span>
<span class="nc" id="L381">            this.connectionAddress = connectionAddress;</span>
<span class="nc" id="L382">        }</span>

        @Override
        public void newScanMessage(String message) {
            // Do nothing
<span class="nc" id="L387">        }</span>

        @Override
        public void newDeviceFound(SecondaryAddress secondaryAddress) {
<span class="nc" id="L391">            driverDeviceScanListener.deviceFound(new DeviceScanInfo(</span>
<span class="nc" id="L392">                    connectionAddress + SEPARATOR + Helper.bytesToHex(secondaryAddress.asByteArray()), &quot;&quot;,</span>
<span class="nc" id="L393">                    getScanDescription(secondaryAddress)));</span>
<span class="nc" id="L394">        }</span>

    }

    private String getScanDescription(SecondaryAddress secondaryAddress) {
<span class="nc" id="L399">        return &quot;ManufactureId:&quot; + secondaryAddress.getManufacturerId() + &quot;;DeviceType:&quot;</span>
<span class="nc" id="L400">                + secondaryAddress.getDeviceType() + &quot;;DeviceID:&quot; + secondaryAddress.getDeviceId() + &quot;;Version:&quot;</span>
<span class="nc" id="L401">                + secondaryAddress.getVersion();</span>
    }

    private class Settings {

<span class="nc" id="L406">        private String scanConnectionAddress = &quot;&quot;;</span>
<span class="nc" id="L407">        private boolean scanSecondary = false;</span>

<span class="nc" id="L409">        private boolean resetLink = false;</span>
<span class="nc" id="L410">        private boolean resetApplication = false;</span>

<span class="nc" id="L412">        private int timeout = 2500;</span>
<span class="nc" id="L413">        private int baudRate = 2400;</span>

<span class="nc" id="L415">        private String host = &quot;&quot;;</span>
        private int port;
<span class="nc" id="L417">        private int connectionTimeout = 10000;</span>
<span class="nc" id="L418">        private int delay = 0;</span>

<span class="nc" id="L420">        private Settings(String settings, boolean scan) throws ArgumentSyntaxException {</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">            if (scan) {</span>
<span class="nc" id="L422">                setScanOptions(settings);</span>
            }
            else {
<span class="nc" id="L425">                parseDeviceSettings(settings);</span>
            }
<span class="nc" id="L427">        }</span>

        private void setScanOptions(String settings) throws ArgumentSyntaxException {
<span class="nc" id="L430">            String message = &quot;Less than one or more than five arguments in the settings are not allowed.&quot;;</span>

<span class="nc bnc" id="L432" title="All 4 branches missed.">            if (settings == null || settings.isEmpty()) {</span>
<span class="nc" id="L433">                throw new ArgumentSyntaxException(&quot;Settings field is empty. &quot; + message);</span>
            }

<span class="nc" id="L436">            String[] args = settings.split(&quot;:&quot;);</span>
<span class="nc bnc" id="L437" title="All 4 branches missed.">            if (settings.isEmpty() || args.length &gt; 5) {</span>
<span class="nc" id="L438">                throw new ArgumentSyntaxException(message);</span>
            }

            int i;
<span class="nc bnc" id="L442" title="All 2 branches missed.">            if (args[0].equalsIgnoreCase(TCP)) {</span>
<span class="nc" id="L443">                host = args[1];</span>
<span class="nc" id="L444">                parsePort(args);</span>
<span class="nc" id="L445">                i = 3;</span>
            }
            else {
<span class="nc" id="L448">                scanConnectionAddress = args[0];</span>
<span class="nc" id="L449">                i = 1;</span>
            }

<span class="nc bnc" id="L452" title="All 2 branches missed.">            for (; i &lt; args.length; ++i) {</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">                if (args[i].equalsIgnoreCase(SECONDARY_ADDRESS_SCAN)) {</span>
<span class="nc" id="L454">                    scanSecondary = true;</span>
                }
<span class="nc bnc" id="L456" title="All 2 branches missed.">                else if (args[i].matches(&quot;^[t,T][0-9]*&quot;)) {</span>
<span class="nc" id="L457">                    String setting = args[i].substring(1);</span>
<span class="nc" id="L458">                    timeout = parseInt(setting, &quot;Timeout is not a parsable number.&quot;);</span>
<span class="nc" id="L459">                }</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">                else if (args[i].matches(&quot;^[d,D][0-9]*&quot;)) {</span>
<span class="nc" id="L461">                    String setting = args[i].substring(1);</span>
<span class="nc" id="L462">                    delay = parseInt(setting, &quot;Settings: Delay is not a parsable number.&quot;);</span>
<span class="nc" id="L463">                }</span>
                else {
                    try {
<span class="nc" id="L466">                        baudRate = Integer.parseInt(args[i]);</span>
<span class="nc" id="L467">                    } catch (NumberFormatException e) {</span>
<span class="nc" id="L468">                        throw new ArgumentSyntaxException(&quot;Argument &quot; + (i + 1) + &quot; is not an integer.&quot;);</span>
<span class="nc" id="L469">                    }</span>
                }
            }
<span class="nc" id="L472">        }</span>

        private void parsePort(String[] args) throws ArgumentSyntaxException {
            try {
<span class="nc" id="L476">                port = Integer.parseInt(args[2]);</span>
<span class="nc" id="L477">            } catch (NumberFormatException e) {</span>
<span class="nc" id="L478">                throw new ArgumentSyntaxException(&quot;Error parsing TCP port&quot;);</span>
<span class="nc" id="L479">            }</span>
<span class="nc" id="L480">        }</span>

        private void parseDeviceSettings(String settings) throws ArgumentSyntaxException {
<span class="nc bnc" id="L483" title="All 2 branches missed.">            if (!settings.isEmpty()) {</span>
<span class="nc" id="L484">                String[] settingArray = settings.split(&quot;:&quot;);</span>

<span class="nc bnc" id="L486" title="All 2 branches missed.">                for (String setting : settingArray) {</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">                    if (setting.matches(&quot;^[t,T][0-9]*&quot;)) {</span>
<span class="nc" id="L488">                        setting = setting.substring(1);</span>
<span class="nc" id="L489">                        timeout = parseInt(setting, &quot;Settings: Timeout is not a parsable number.&quot;);</span>
                    }
<span class="nc bnc" id="L491" title="All 2 branches missed.">                    else if (setting.matches(&quot;^[tc,TC][0-9]*&quot;)) {</span>
<span class="nc" id="L492">                        setting = setting.substring(1);</span>
<span class="nc" id="L493">                        connectionTimeout = parseInt(setting, &quot;Settings: Connection timeout is not a parsable number.&quot;);</span>
                    }
<span class="nc bnc" id="L495" title="All 2 branches missed.">                    else if (setting.matches(&quot;^[d,D][0-9]*&quot;)) {</span>
<span class="nc" id="L496">                        setting = setting.substring(1);</span>
<span class="nc" id="L497">                        delay = parseInt(setting, &quot;Settings: Delay is not a parsable number.&quot;);</span>
                    }
<span class="nc bnc" id="L499" title="All 2 branches missed.">                    else if (setting.equals(LINK_RESET)) {</span>
<span class="nc" id="L500">                        resetLink = true;</span>
                    }
<span class="nc bnc" id="L502" title="All 2 branches missed.">                    else if (setting.equals(APPLICATION_RESET)) {</span>
<span class="nc" id="L503">                        resetApplication = true;</span>
                    }
<span class="nc bnc" id="L505" title="All 2 branches missed.">                    else if (setting.equals(STRICT_CONNECTION)) {</span>
<span class="nc" id="L506">                        strictConnectionTest = true;</span>
                    }
<span class="nc bnc" id="L508" title="All 2 branches missed.">                    else if (setting.matches(&quot;^[0-9]*&quot;)) {</span>
<span class="nc" id="L509">                        baudRate = parseInt(setting, &quot;Settings: Baudrate is not a parseable number.&quot;);</span>
                    }
                    else {
<span class="nc" id="L512">                        throw new ArgumentSyntaxException(&quot;Settings: Unknown settings parameter. [&quot; + setting + &quot;]&quot;);</span>
                    }
                }

            }
<span class="nc" id="L517">        }</span>

        private int parseInt(String setting, String errorMsg) throws ArgumentSyntaxException {
            int ret;
            try {
<span class="nc" id="L522">                ret = Integer.parseInt(setting);</span>
<span class="nc" id="L523">            } catch (NumberFormatException e) {</span>
<span class="nc" id="L524">                throw new ArgumentSyntaxException(errorMsg + &quot; [&quot; + setting + &quot;]&quot;);</span>
<span class="nc" id="L525">            }</span>
<span class="nc" id="L526">            return ret;</span>
        }
    }

<span class="nc" id="L530">    private class VerboseMessageListenerImpl implements VerboseMessageListener {</span>

        @Override
        public void newVerboseMessage(org.openmuc.jmbus.VerboseMessage debugMessage) {
<span class="nc" id="L534">            String msgDir = debugMessage.getMessageDirection().toString().toLowerCase();</span>
<span class="nc" id="L535">            String msgHex = Helper.bytesToHex(debugMessage.getMessage());</span>
<span class="nc" id="L536">            logger.trace(&quot;{} message: {}&quot;, msgDir, msgHex);</span>
<span class="nc" id="L537">        }</span>

    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>